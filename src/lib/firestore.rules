
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // registrationRequests: 
    match /registrationRequests/{requestId} {
      allow create: if true;
      allow get, update, delete: if request.auth != null && get(/databases/$(database)/documents/roles/userRoles).data[request.auth.uid] == 'admin';
    }

    // roles/userRoles:
    match /roles/userRoles {
        allow read: if request.auth != null;
        allow write: if request.auth != null && get(/databases/$(database)/documents/roles/userRoles).data[request.auth.uid] == 'admin';
    }

    // Regla global para LISTAR colecciones.
    // Permite que un administrador liste CUALQUIER colección, que es necesario para las tablas y reportes.
    match /{path=**}/{collection} {
      allow list: if request.auth != null && get(/databases/$(database)/documents/roles/userRoles).data[request.auth.uid] == 'admin';
    }
    
    // Regla para OBTENER documentos individuales.
    // Permite el acceso si el usuario es un 'admin' O si su UID existe en la lista de roles.
    match /{collection}/{docId} {
      allow read, write: if request.auth != null && exists(/databases/$(database)/documents/roles/userRoles) && (
        get(/databases/$(database)/documents/roles/userRoles).data[request.auth.uid] == 'admin' ||
        request.auth.uid in get(/databases/$(database)/documents/roles/userRoles).data
      );
    }
    
    // Regla para el formulario de contacto público
    match /contactLeads/{leadId} {
      allow create: if true;
      allow read, update, delete: if request.auth != null && get(/databases/$(database)/documents/roles/userRoles).data[request.auth.uid] == 'admin';
    }
  }
}
